---
date: '<p>Exported on: `r format(Sys.time(), "%a %b %d %X %Y")` <br/> <br/>See [rave.wiki](https://rave.wiki) for more details</p>' 
output: 
  html_document: 
    toc: true
    toc_float: 
      collapsed: true
    toc_depth: 3
    df_print: kable
    theme: spacelab
params:
  plots_to_include: 
    - over_time_by_electrode
    - by_frequency_over_time
    - over_time_by_trial
    - over_time_by_condition
  do_overall_plots: true
  do_individual_plots: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
require(knitr)
require(fontawesome)
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=NA)

pe_graphics_settings_cache <- dipsaus::rds_map(file.path('preferences', 'graphics'))
raveio::pipeline_set_preferences("power_explorer.graphics.reset_on_load" = FALSE)

ravepipeline::pipeline_setup_rmd("power_explorer")
# options("raveio.debug" = TRUE)

pipeline <- ravepipeline::pipeline("power_explorer", paths = "..", temporary = TRUE)


env <- pipeline$shared_env()
list2env(as.list(env), globalenv())

repository <- pipeline$read('repository')

project <- repository$project$name
subject <- repository$subject$subject_code

brain <- raveio::rave_brain(repository$subject)
# 
# og.pe_graphics_settings_cache <- dipsaus::rds_map(file.path(pipeline$preference_path, "graphics"))
# 
# # grab the functions we need
# lapply(sort(list.files(
#   "R/", ignore.case = TRUE,
#   pattern = "^shared-.*\\.R", 
#   full.names = TRUE
# )), function(f) {
#   source(f, local = FALSE, chdir = TRUE)
# })
# 
# pe_graphics_settings_cache <- og.pe_graphics_settings_cache

# format the univariate statistical results
# this code taken from module_server.R$per_electrode_results_table
omnibus_data <- pipeline$read('omnibus_results')

mat <- t(omnibus_data$stats)
mat <- cbind('Electrode'=as.numeric(rownames(mat)), mat)
rownames(mat)=NULL

omnibus_statistics_df <- data.frame(mat)
cnames <- colnames(mat)

pcols <- stringr::str_detect(cnames, 'p\\(|p_fdr\\(')
omnibus_statistics_df[pcols] %<>% lapply(function(v)as.numeric(round_pval(v)))
```

```{r plotting_functions, include=FALSE}
call_plot_from_name <- function(nm, pipe, pipe_promise) {
  
  if(missing(pipe)) {
    dd <- pipe_promise$get_values(paste0(nm, '_data'))
  } else {
    dd <- pipe$read(paste0(nm, '_data'))
  }
  
  po <- pe_graphics_settings_cache$get(paste0(nm, '_plot_options'))
  
  FUN <- match.fun(paste0('plot_', nm))
  
  FUN(dd, po)
}
```

---
title: "RAVE | `r sprintf("Proj: %s, Subj: %s", project, subject)`"
---


## Baseline and analysis settings
```{r}
baseline_settings <- pipeline$read("baseline_settings")
baseline_settings$window <- paste0(collapse=',', baseline_settings$window[[1]])

kable(
  caption='Baseline settings', data.frame(baseline_settings)
)

# strip out redundant/uninformative details
clean_settings <- function(ascs) {
  lapply(ascs, function(asc) {
    asc$frequency_dd <- NULL
    asc$subject_code <- NULL
    asc$project_name <- NULL
    
    if(!isTRUE(asc$censor_info$enabled)) {
      asc$censor_info <- NULL
    }
    
    asc$time %<>% paste0(collapse='-')
    asc$frequency %<>% paste0(collapse=':')
    
    asc
  })
}

# details on how electrodes were processed / anatomy 
analysis_settings_clean <- rbind_list(clean_settings(pipeline$read("analysis_settings_clean")))

kable(
  caption = 'Analysis settings',
  analysis_settings_clean
)

# metadata=list(
#   subject = repository$subject$subject_code,
#   project = repository$subject$project_name,
#   baseline_window = paste0(collapse=':', baseline_settings$window[[1]]), 
#   baseline_scope = baseline_settings$scope[[1]],
#   unit = uoa,
#   signal_type = repository$signal_type,
#   reference = subset(repository$reference_table, Electrode %in% electrodes_to_keep),
#   electrodes = subset(repository$electrode_table, Electrode %in% electrodes_to_keep)
# )
```

## Brain viewer
<button class="btn btn-primary btn-xs" data-toggle="collapse" data-target="#brainviewer"> Show/Hide </button>  
<div id="brainviewer" class="collapse">  
```{r, fig.width=10, fig.align='center'}

brain$set_electrode_values(omnibus_statistics_df)

brain$plot(control_display = FALSE, side_display=FALSE, cex=7/8, start_zoom = 7/8,
           width='100%', height='600px')
```
</div>

## Univariate statistics
```{r}

# if we're plotting individual electrodes, include anchor links
if(params$do_individual_plots) {
  omnibus_statistics_df$Electrode %<>% sapply(function(ee) {
    sprintf('<a href="#%s_stats">%s</a>',ee,ee)
  })
}

dt <- DT::datatable(escape = FALSE,
                    omnibus_statistics_df, colnames=cnames, rownames = FALSE,
                    # extensions = c('FixedColumns', 'FixedHeader', 'Scroller', 'Buttons'),
                    extensions = c("Buttons"),
                    options=list(autoWidth=TRUE, scroller=TRUE, scrollX=TRUE, scrollY=TRUE,
                                 buttons = list(list(extend = 'copy', text='copy', title = NULL)),
                                 fixedColumns = list(leftColumns = 1), class='display', escape=FALSE,
                                 server=FALSE, #order=TRUE,
                                 # columnDefs = list(
                                 # list(width = '50px', targets = "_all")
                                 # ),
                                 dom = 'lftp<"small"B>'
                    )
)

char = sapply(omnibus_statistics_df, function(x) any(!is.numeric(x)))
to_round <- omnibus_statistics_df[!(pcols|char)] %>% sapply(get_pretty_digits)

for(ur in unique(to_round)) {
  nms <- names(which(to_round == ur))
  dt %<>% DT::formatRound(nms, digits=ur+1)
}

dt

```
<!-- Back to top [`r fa("arrow-up", fill = "steelblue")`](#top) -->



`r if(params$do_overall_plots) "## Across electrodes graphs"`

```{r, fig.width=12, fig.align='center', results='hide', eval=params$do_overall_plots}
lapply(params$plots_to_include, call_plot_from_name, pipe=pipeline)
```


<script>
$( "input.hideshow" ).each( function ( index, button ) {
$( button ).click( function () {
var target = this.nextSibling ? this : this.parentNode;
target = target.nextSibling.nextSibling.nextSibling.nextSibling;
if ( target.style.display == 'block' || target.style.display == '' ) {
target.style.display = 'none';
} else {
target.style.display = 'block';
}
} );
} );
</script>

`r if(params$do_individual_plots) "## Per electrode results"`

```{r per_electrode_results, fig.width=12, fig.align='center', results='asis', eval=params$do_individual_plots}

orig.settings <- pipeline$get_settings()

wanted <- c('Electrode', 'Label', 'FSLabel')
cols_to_keep <- intersect(wanted, colnames(brain$electrodes$raw_table))

if(! 'FSLabel' %in% cols_to_keep) {
  
  if('Area_fs' %in% colnames(brain$electrodes$raw_table)) {
    brain$electrodes$raw_table$FSLabel <- brain$electrodes$raw_table$Area_fs
    cols_to_keep %<>% c('FSLabel')
  }
}

all_els <- dipsaus::parse_svec(orig.settings$analysis_electrodes)
# get only electrodes that are available in the repo
all_els <- all_els[all_els %in% repository$power$dimnames$Electrode]

electrode_details <- subset(brain$electrodes$raw_table,
                            Electrode %in% all_els,
                            select=cols_to_keep)

build_description <- function(df_row) {
  str <- list(
    'header' = '',
    'body' = ''
  )
  
  
  str$header = sprintf('Contact %s | %s', df_row$Electrode, df_row$Label)
  
  if('FSLabel' %in% names(df_row)) {
    str$body = df_row$FSLabel
  }
  
  return(str)
}

# all the data objects we need
data_needed <- params$plots_to_include %&% '_data'

# progress <- dipsaus::progress2("Working on individual electrodes", max = length(all_els) +
#                                  1, shiny_auto_close = FALSE)

# temp_root <- tempfile(pattern = "rave-report-")
# if(file.exists(temp_root)) {
#   unlink(temp_root, recursive = TRUE)
# }

# setup to remove any temp directories we create to run the sub-pipelines

pipe_res <- lapply(all_els, function(ee) {
  # print(ee)
  
  pdir <- file.path(sprintf('%s/e%s', tempdir(), ee))
  unlink(pdir, recursive = TRUE)
  raveio::dir_create2(pdir)
  
  my_pipeline <- pipeline$fork(pdir)
  
  gsi <- orig.settings
  gsi$analysis_electrodes <- as.character(ee)
  
  my_pipeline$set_settings(.list = gsi)
  
  utils::capture.output({
    res <- my_pipeline$run(names = data_needed, debug = FALSE, async =TRUE)
  })
  
  res
})
  
for(ee in seq_along(all_els)) {
  el <- all_els[ee]
  
  ravedash::logger("Working on e: ", el, level='debug')
  # progress$inc(detail = sprintf("Generating graphs for electrode %s", el))
  
  # gsi <- orig.settings
  edesc <- build_description(subset(electrode_details, Electrode == el))
  
  cat(sprintf("<h3 id='%s_stats'>%s</h2>\n", ee, edesc$header))
  cat(sprintf("<p>%s</p>", edesc$body))
  
  # gsi$analysis_electrodes <- as.character(ee)
  
  # pipeline$set_settings(.list = gsi)
  # utils::capture.output(pipeline$run(names = data_needed, debug = FALSE))
  
  utils::capture.output({
    brain$plot_electrodes_on_slices(
      ee, zoom = 2, electrode_size = 3, title_position='top',
      decoration = function(i, j) {
        graphics::points(0, 0, pch = 21, col = 'orange', cex = 2.25, lwd=2.5)
      }
    )
  })
  
  lapply(params$plots_to_include, call_plot_from_name, pipe_promise = pipe_res[[ee]])
  
  cat(sprintf("Back to top [%s](#top)", fa("arrow-up", fill = "steelblue")))
}
# progress$close()
# set back the original settings, but note that we aren't re-running things
pipeline$set_settings(.list = orig.settings)

```

```{r cleanup, results='hide', include=FALSE}
utils::capture.output({
  a <- lapply(all_els, function(ee) {
    pdir <- file.path(sprintf('%s/e%s', tempdir(), ee))
    unlink(pdir, recursive = TRUE)
  })
})
```
